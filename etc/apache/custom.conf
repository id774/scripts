# /etc/apache2/sites-available/custom.conf
<VirtualHost *:80>
  # Administrator contact email
  ServerAdmin idnanashi@gmail.com

  # Primary domain and aliases for this virtual host
  ServerName  wyvern.id774.net
  ServerAlias www.id774.net docs.id774.net git.id774.net blog.id774.net files.id774.net

  # Disable Apache signature in error pages
  ServerSignature Off

  # WordPress environment variables for site URL configuration
  SetEnv WP_HOME    https://blog.id774.net/entry
  SetEnv WP_SITEURL https://blog.id774.net/entry
  <IfModule proxy_fcgi_module>
    # Pass WordPress site URL variables through PHP-FPM (FastCGI)
    ProxyFCGISetEnvIf "true" WP_HOME    "https://blog.id774.net/entry"
    ProxyFCGISetEnvIf "true" WP_SITEURL "https://blog.id774.net/entry"
  </IfModule>

  # Main document root for web content
  DocumentRoot /var/www/html/current

  # Root directory restrictions (deny everything by default)
  <Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
  </Directory>

  # Base HTML directory (allow overrides and public access)
  <Directory /var/www/html>
    Options FollowSymLinks
    AllowOverride All
    Require all granted
  </Directory>

  # Current document root (allow overrides, index files, public access)
  <Directory /var/www/html/current>
    Options FollowSymLinks
    AllowOverride All
    Require all granted
    DirectoryIndex index.php index.html
  </Directory>

  # --- CGI Settings
  ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
  <Directory "/usr/lib/cgi-bin">
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    Require all granted
  </Directory>

  # --- Logging
  ErrorLog  /var/log/apache2/error.log
  LogLevel  warn
  CustomLog /var/log/apache2/access.log combined

  # --- Public documentation directory (restricted to localhost access)
  Alias /doc/ "/usr/share/doc/"
  <Directory "/usr/share/doc/">
    Options MultiViews FollowSymLinks
    AllowOverride None
    Require ip 127.0.0.0/8 ::1/128
  </Directory>

  # --- Rewrite rules (redirects and HTTPS enforcement)
  <IfModule mod_rewrite.c>
    # Exception rules for ACME challenge (Let's Encrypt)
    Include /etc/apache2/snippets/acme-rewrite-exception.conf

    RewriteEngine On

    # Redirect blog-related paths to WordPress entry
    RewriteCond %{HTTP_HOST} !^harpuia\.id774\.net$
    RewriteCond %{HTTP_HOST} !^ray\.id774\.net$
    RewriteRule ^/(blogs|blog|post)/(.+)$ https://blog.id774.net/entry/%2 [R=301,L]

    # Redirect bare domain to www
    RewriteCond %{HTTP_HOST} ^id774\.net$
    RewriteRule ^/$ https://www.id774.net [R=301,L]

    # Allow explicit access to /server-status
    RewriteRule ^/server-status$ - [END]

    # Enforce HTTPS for all other requests
    RewriteCond %{HTTPS} !=on
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
  </IfModule>
</VirtualHost>
