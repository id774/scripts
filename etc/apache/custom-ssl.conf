# /etc/apache2/sites-available/custom-ssl.conf
<IfModule mod_ssl.c>
<VirtualHost *:443>
  # Administrator contact email
  ServerAdmin idnanashi@gmail.com

  # Primary domain and aliases for this virtual host
  ServerName  wyvern.id774.net
  ServerAlias www.id774.net docs.id774.net git.id774.net blog.id774.net files.id774.net

  # Disable Apache signature in error pages
  ServerSignature Off

  # WordPress environment variables for site URL configuration
  SetEnv WP_HOME    https://blog.id774.net/entry
  SetEnv WP_SITEURL https://blog.id774.net/entry
  <IfModule proxy_fcgi_module>
    # Pass WordPress site URL variables through PHP-FPM (FastCGI)
    ProxyFCGISetEnvIf "true" WP_HOME    "https://blog.id774.net/entry"
    ProxyFCGISetEnvIf "true" WP_SITEURL "https://blog.id774.net/entry"
  </IfModule>

  # Main document root for web content
  DocumentRoot /var/www/html/current

  # Root directory restrictions (deny everything by default)
  <Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
  </Directory>

  # Base HTML directory (allow overrides and public access)
  <Directory /var/www/html>
    Options FollowSymLinks
    AllowOverride All
    Require all granted
  </Directory>

  # Current document root (allow overrides, index files, public access)
  <Directory /var/www/html/current>
    Options FollowSymLinks
    AllowOverride All
    Require all granted
    DirectoryIndex index.php index.html
  </Directory>

  # --- CGI Settings
  ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
  <Directory /usr/lib/cgi-bin>
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    Require all granted
    SSLOptions +StdEnvVars
  </Directory>

  # --- Logging
  ErrorLog  /var/log/apache2/error.log
  LogLevel  warn
  CustomLog /var/log/apache2/ssl_access.log combined

  # --- Public documentation directory (restricted to localhost access)
  Alias /doc/ "/usr/share/doc/"
  <Directory "/usr/share/doc/">
    Options MultiViews FollowSymLinks
    AllowOverride None
    Require ip 127.0.0.0/8 ::1/128
  </Directory>

  # --- TLS (Let's Encrypt certificates)
  SSLEngine on
  SSLCertificateFile    /etc/letsencrypt/live/www.id774.net/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/www.id774.net/privkey.pem

  # Allow Let's Encrypt ACME challenge requests
  Alias /.well-known/acme-challenge/ "/var/www/html/current/.well-known/acme-challenge/"
  <Directory "/var/www/html/current/.well-known/acme-challenge/">
    Options +FollowSymLinks
    AllowOverride None
    RewriteEngine Off
    Require all granted
  </Directory>

  # Include exception rules for ACME challenges
  Include /etc/apache2/snippets/acme-rewrite-exception.conf

  # --- SSL options for specific file types
  <FilesMatch "\.(cgi|shtml|phtml|php)$">
    SSLOptions +StdEnvVars
  </FilesMatch>

  # --- Browser compatibility settings for old versions of Internet Explorer
  BrowserMatch "MSIE [2-6]" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
</VirtualHost>
</IfModule>
