#!/bin/sh

export JOBLOG=/var/log/sysadmin/run_tests.log
export SCRIPTS=/home/debian/scripts

run_tests() {
    python_version=$1
    ruby_version=$2
    echo "=== Running Tests with Python $python_version and Ruby $ruby_version ===" >>$JOBLOG 2>&1
    $SCRIPTS/run_tests.sh /opt/python/$python_version/bin/python /opt/ruby/$ruby_version/bin/rspec >>$JOBLOG 2>&1
}

echo -n "*** $0: Job started on `/bin/hostname` at " >>$JOBLOG 2>&1
date "+%Y/%m/%d %T" >>$JOBLOG 2>&1

python_versions="3.12 3.11 3.10 3.9 3.8 3.7 3.6"
ruby_versions="3.3 3.2 3.1 3.0"

for ruby_version in $ruby_versions; do
    for python_version in $python_versions; do
        run_tests $python_version $ruby_version
    done
done

echo -n "*** $0: Job ended on `/bin/hostname` at " >>$JOBLOG 2>&1
date "+%Y/%m/%d %T" >>$JOBLOG 2>&1

if grep -q "Some tests failed" $JOBLOG; then
    echo "*** $0: Some tests failed. Check the logs for details." >>$JOBLOG 2>&1
    exit 1
else
    echo "*** $0: All tests completed successfully for all versions." >>$JOBLOG 2>&1
    exit 0
fi

echo >>$JOBLOG 2>&1
